<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Shogi Board - Fixed Import</title>
    <style>
        :root {
            --board-bg: #dab982; --cell-border: #4e342e; --sente-color: #1a1a1a; --nari-color: #8b0000; 
            --highlight-bg: rgba(211, 84, 0, 0.3); --last-move-bg: rgba(255, 255, 0, 0.3);
            --move-dot: rgba(0, 0, 0, 0.2); --text-main: #3e2723; --ui-bg: #e0d7d2;
            --sente-accent: #d35400; --btn-bg: #5d4037;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        body { font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif; background: #1a1a1a; color: var(--text-main); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; user-select: none; }
        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1400px; }
        @media (max-width: 1000px) {
            .main-container { flex-direction: column; align-items: center; }
            .side-panel { width: 100% !important; max-width: 600px; }
            #board { grid-template-columns: repeat(9, 10.5vw) !important; grid-template-rows: repeat(9, 11.5vw) !important; }
            .piece { font-size: 7.5vw !important; }
            .komadai { width: 95vw !important; height: 60px !important; }
        }
        .board-area { display: flex; flex-direction: column; gap: 10px; align-items: center; flex: 1; }
        .komadai { width: 540px; height: 70px; background: #a1887f; padding: 5px 15px; border-radius: 8px; display: flex; align-items: center; flex-wrap: wrap; gap: 12px; border: 2px solid transparent; }
        .komadai.active-sente { border-color: var(--sente-accent); box-shadow: 0 0 10px var(--sente-accent); }
        .komadai.active-gote { border-color: #eee; box-shadow: 0 0 10px #eee; }
        .board-wrapper { position: relative; background: #4e342e; padding: 10px; border-radius: 4px; }
        #board { display: grid; grid-template-columns: repeat(9, 60px); grid-template-rows: repeat(9, 66px); background: var(--board-bg); border: 1px solid var(--cell-border); }
        .cell { border: 0.5px solid var(--cell-border); display: flex; justify-content: center; align-items: center; position: relative; }
        .cell.selected { background: var(--highlight-bg); }
        .cell.last-move { background: var(--last-move-bg); }
        .piece { font-size: 44px; font-weight: bold; pointer-events: none; color: var(--sente-color); }
        .piece.gote { transform: rotate(180deg); }
        .piece.nari { color: var(--nari-color); }
        .side-panel { width: 380px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--ui-bg); padding: 15px; border-radius: 12px; border: 1px solid #a1887f; }
        .card-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; border-left: 4px solid var(--btn-bg); padding-left: 8px; }
        .action-btn { width: 100%; padding: 10px; font-weight: bold; border: none; border-radius: 6px; color: #fff; background: var(--btn-bg); cursor: pointer; margin-top: 4px; }
        input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #a1887f; margin-bottom: 5px; }
        .kifu-select { width: 100%; padding: 8px; border-radius: 6px; height: 120px; }
        .history-box { height: 200px; overflow-y: scroll; background: #efebe9; border: 1px solid #a1887f; border-radius: 6px; }
        .history-item { padding: 8px; border-bottom: 1px solid #d7ccc8; font-size: 0.85rem; cursor: pointer; }
        .current-move { background: #d7ccc8; border-left: 5px solid var(--sente-accent); }
    </style>
</head>
<body>

<div class="main-container">
    <div class="board-area">
        <div class="komadai gote" id="goteKomadaiContainer"></div>
        <div class="board-wrapper">
            <div id="board"></div>
            <div id="promoteSelector" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; display: none; z-index: 100; gap: 40px; border: 3px solid var(--btn-bg);">
                <div onclick="processPromotion(true)" style="text-align:center; cursor:pointer;"><div class="piece sente nari" id="promoYesPiece"></div><div>成る</div></div>
                <div onclick="processPromotion(false)" style="text-align:center; cursor:pointer;"><div class="piece sente" id="promoNoPiece"></div><div>成らず</div></div>
            </div>
        </div>
        <div class="komadai sente" id="senteKomadaiContainer"></div>
        <div class="btn-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; width: 100%; max-width: 540px;">
            <button class="action-btn" onclick="jumpTo(0)">|&lt;</button>
            <button class="action-btn" onclick="prevMove()">&lt;</button>
            <button class="action-btn" onclick="nextMove()">&gt;</button>
            <button class="action-btn" onclick="jumpTo(history.length - 1)">&gt;|</button>
        </div>
    </div>

    <div class="side-panel">
        <div class="card">
            <span class="card-title">棋譜の保存</span>
            <input type="text" id="kifuName" placeholder="棋譜名を入力...">
            <button class="action-btn" style="background:var(--sente-accent);" onclick="saveKifu()">保存</button>
        </div>
        <div class="card">
            <span class="card-title">リスト</span>
            <select id="kifuList" size="5" class="kifu-select"></select>
            <button class="action-btn" style="background:#2c3e50;" onclick="loadKifu()">読込</button>
        </div>
        <div class="card">
            <span class="card-title">入出力</span>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button class="action-btn" style="background:#27ae60;" onclick="exportKIF()">KIF出力</button>
                <button class="action-btn" style="background:#2980b9;" onclick="document.getElementById('kifIn').click()">KIF読込</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                <button class="action-btn" style="background:#7f8c8d;" onclick="exportAllJSON()">まとめてDL</button>
                <button class="action-btn" style="background:#8e44ad;" onclick="document.getElementById('jsonIn').click()">まとめてUL</button>
            </div>
            <input type="file" id="kifIn" style="display:none" accept=".kif" onchange="importKIF(event)">
            <input type="file" id="jsonIn" style="display:none" accept=".json" onchange="importAllJSON(event)">
        </div>
        <div class="card">
            <span class="card-title">履歴</span>
            <div id="history" class="history-box"></div>
        </div>
    </div>
</div>

<script>
    let history = []; let currentIndex = 0; let selected = null; let pendingMove = null;
    const kanjiMap = {'p':'歩','r':'飛','b':'角','g':'金','s':'銀','n':'桂','l':'香','k':'玉','+p':'と','+r':'竜','+b':'馬','+s':'全','+n':'圭','+l':'杏'};
    const kifPieceMap = {'歩':'p','飛':'r','角':'b','金':'g','銀':'s','桂':'n','香':'l','玉':'k','王':'k','と':'+p','竜':'+r','龍':'+r','馬':'+b','成銀':'+s','成桂':'+n','成香':'+l','全':'+s','圭':'+n','杏':'+l'};
    const STORAGE_KEY = 'SHOGI_LS_DATA_V3';

    const initBoard = [['L','N','S','G','K','G','S','N','L'],['','R','','','','','','B',''],['P','P','P','P','P','P','P','P','P'],['','','','','','','','',''],['','','','','','','','',''],['','','','','','','','',''],['p','p','p','p','p','p','p','p','p'],['','b','','','','','','r',''],['l','n','s','g','k','g','s','n','l']];
    function getCleanHistory() { return [{ board: JSON.parse(JSON.stringify(initBoard)), senteMoti: [], goteMoti: [], moveText: "開始局面", turn: 0, lastPos: null, kifMove: "" }]; }
    history = getCleanHistory();

    function render() {
        const data = history[currentIndex];
        const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
        document.getElementById('senteKomadaiContainer').className = "komadai sente" + (data.turn===0 ? " active-sente" : "");
        document.getElementById('goteKomadaiContainer').className = "komadai gote" + (data.turn===1 ? " active-gote" : "");

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div'); cell.className = 'cell';
                if (data.lastPos && data.lastPos.r === r && data.lastPos.c === c) cell.classList.add('last-move');
                const p = data.board[r][c];
                if (p) {
                    const span = document.createElement('span');
                    span.className = 'piece ' + (p === p.toUpperCase() ? 'gote ' : 'sente ') + (p.includes('+') ? 'nari' : '');
                    span.innerText = kanjiMap[p.toLowerCase()]; cell.appendChild(span);
                }
                cell.onclick = () => handleCellClick(r, c); boardEl.appendChild(cell);
            }
        }
        renderMoti('senteKomadaiContainer', data.senteMoti, 0);
        renderMoti('goteKomadaiContainer', data.goteMoti, 1);
        updateHistoryUI();
    }

    function renderMoti(id, pieces, owner) {
        const el = document.getElementById(id); el.innerHTML = '';
        const counts = {}; (pieces||[]).forEach(p => counts[p] = (counts[p] || 0) + 1);
        ['r','b','g','s','n','l','p'].forEach(type => {
            if (counts[type]) {
                const group = document.createElement('div');
                const span = document.createElement('span'); span.className = 'piece' + (owner===1?' gote':'');
                span.innerText = kanjiMap[type]; span.style.fontSize="30px"; group.appendChild(span);
                if(counts[type]>1){ const b=document.createElement('span'); b.innerText=counts[type]; b.style.fontSize="12px"; group.appendChild(b); }
                el.appendChild(group);
            }
        });
    }

    function executeMove(fr, fc, tr, tc, p, isPromote, isDrop = false) {
        const d = history[currentIndex];
        const nb = JSON.parse(JSON.stringify(d.board));
        const sm = [...d.senteMoti]; const gm = [...d.goteMoti];
        const isSente = d.turn === 0;

        if (isDrop) {
            nb[tr][tc] = isSente ? p.toLowerCase() : p.toUpperCase();
            const targetMoti = isSente ? sm : gm;
            targetMoti.splice(targetMoti.indexOf(p.toLowerCase()), 1);
        } else {
            const captured = nb[tr][tc];
            if (captured) {
                const c = captured.replace('+', '').toLowerCase();
                (isSente ? sm : gm).push(c);
            }
            let finalPiece = isPromote ? "+" + p.toLowerCase() : p.toLowerCase();
            nb[tr][tc] = isSente ? finalPiece : finalPiece.toUpperCase();
            nb[fr][fc] = '';
        }

        const kifM = `${String.fromCharCode(9-tc+0xFEE0)}${["","一","二","三","四","五","六","七","八","九"][tr+1]}${kanjiMap[p.toLowerCase()]}${isPromote?'成':''}${isDrop?'打':''}(${9-fc}${fr+1})`;
        history.push({
            board: nb, senteMoti: sm, goteMoti: gm,
            moveText: (isSente ? "▲" : "△") + kanjiMap[p.toLowerCase()] + (isPromote ? "成" : "") + (isDrop ? "打" : "") + `(${9-tc}${tr+1})`,
            turn: 1 - d.turn, lastPos: { r: tr, c: tc }, kifMove: kifM
        });
        currentIndex++;
    }

    function importKIF(e) {
        const f = e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                history = getCleanHistory(); currentIndex = 0;
                const lines = ev.target.result.split('\n');
                lines.forEach(line => {
                    const m = line.match(/^\s*(\d+)\s+([１-９一-九同].+?)(?:\s|\(|$)/);
                    if (!m) return;
                    let moveStr = m[2];
                    let tr, tc, fr, fc, pieceChar, isProm = moveStr.includes('成');
                    
                    if (moveStr.startsWith('同')) {
                        tr = history[currentIndex].lastPos.r; tc = history[currentIndex].lastPos.c;
                    } else {
                        tc = 9 - ("１２３４５６７８９".indexOf(moveStr[0]) + 1);
                        tr = "一二三四五六七八九".indexOf(moveStr[1]);
                    }

                    pieceChar = moveStr.match(/[歩飛角金銀桂香玉王と竜龍馬全圭杏]/)[0];
                    const pCode = kifPieceMap[pieceChar].replace('+', '');

                    if (moveStr.includes('打')) {
                        executeMove(null, null, tr, tc, pCode, false, true);
                    } else {
                        const fm = line.match(/\((\d)(\d)\)/);
                        if (fm) {
                            fc = 9 - parseInt(fm[1]); fr = parseInt(fm[2]) - 1;
                        } else {
                            // 移動元がない場合の検索
                            const d = history[currentIndex];
                            findSource: for(let r=0; r<9; r++) for(let c=0; c<9; c++){
                                let p = d.board[r][c];
                                if(p && p.toLowerCase().replace('+','') === pCode){
                                    const isS = p === p.toLowerCase();
                                    if((isS && d.turn===0) || (!isS && d.turn===1)) { fr=r; fc=c; break findSource; }
                                }
                            }
                        }
                        executeMove(fr, fc, tr, tc, pCode, isProm, false);
                    }
                });
                render(); alert("読込完了");
            } catch (err) { alert("解析失敗"); console.log(err); }
        };
        reader.readAsText(f, "utf-8"); e.target.value = "";
    }

    function updateHistoryUI() { 
        const h = document.getElementById('history');
        h.innerHTML = history.map((x,i) => `<div class="history-item ${i===currentIndex?'current-move':''}" onclick="jumpTo(${i})">${i}. ${x.moveText}</div>`).join('');
        h.scrollTop = h.scrollHeight;
    }
    function jumpTo(i) { currentIndex = i; render(); }
    function prevMove() { if(currentIndex > 0) jumpTo(currentIndex-1); }
    function nextMove() { if(currentIndex < history.length-1) jumpTo(currentIndex+1); }
    function saveKifu() { const n = document.getElementById('kifuName').value; if(!n) return; const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); d[n] = history; localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); updateList(); }
    function updateList() { const d = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); document.getElementById('kifuList').innerHTML = Object.keys(d).map(k => `<option value="${k}">${k}</option>`).join(''); }
    function loadKifu() { const n = document.getElementById('kifuList').value; if(n){ history = JSON.parse(localStorage.getItem(STORAGE_KEY))[n]; currentIndex = 0; render(); } }
    function exportAllJSON() { const d = localStorage.getItem(STORAGE_KEY); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([d], {type:'application/json'})); a.download = 'shogi_backup.json'; a.click(); }
    function exportKIF() {
        let kif = `手合割：平手\n手数----指手----\n`;
        history.forEach((h, i) => { if(i>0) kif += `${i} ${h.kifMove}\n`; });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([kif], {type:'text/plain'})); a.download = 'kifu.kif'; a.click();
    }
    window.onload = () => { render(); updateList(); };
</script>
</body>
</html>