<!DOCTYPE html>
<html lang="ja">
<head>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const isExcluded = urlParams.has('nosave');

      if (!isExcluded) {
        const gtagScript = document.createElement('script');
        gtagScript.async = true;
        gtagScript.src = "https://www.googletagmanager.com/gtag/js?id=G-WLRD9NY9NX";
        document.head.appendChild(gtagScript);

        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WLRD9NY9NX');
      }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>本格将棋盤 - 連打対策済</title>
    <style>
        :root {
            --board-bg: #dab982; 
            --cell-border: #4e342e; 
            --sente-color: #1a1a1a; 
            --nari-color: #8b0000; 
            --highlight-bg: rgba(211, 84, 0, 0.3);
            --move-dot: rgba(0, 0, 0, 0.2);
            --text-main: #3e2723;
            --ui-bg: #e0d7d2;
            --sente-accent: #d35400;
            --btn-bg: #5d4037;
            --btn-hover: #795548;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            /* ダブルタップズームを無効化し、反応を速くする */
            touch-action: manipulation; 
        }
        
        body { 
            font-family: "Hiragino Sans", "Hiragino Kaku Gothic ProN", sans-serif; 
            background: #1a1a1a; 
            color: var(--text-main); 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            padding: 10px; 
            /* 画面全体の意図しないテキスト選択を防ぐ */
            user-select: none; 
            -webkit-user-select: none;
        }

        .main-container { display: flex; gap: 20px; width: 100%; max-width: 1400px; }

        @media (max-width: 1000px) {
            .main-container { flex-direction: column; align-items: center; }
            .side-panel { width: 100% !important; max-width: 600px; }
            #board { grid-template-columns: repeat(9, 10.5vw) !important; grid-template-rows: repeat(9, 11.5vw) !important; }
            .piece { font-size: 7.5vw !important; }
            .komadai { width: 95vw !important; height: 60px !important; }
        }

        .board-area { display: flex; flex-direction: column; gap: 10px; align-items: center; flex: 1; padding-top: 10px; }
        
        .komadai { 
            width: 540px; height: 70px; min-height: 70px;
            background: #a1887f; padding: 5px 15px; border-radius: 8px; 
            display: flex; align-items: center; flex-wrap: wrap; align-content: center;
            gap: 12px; border: 2px solid transparent; overflow: hidden;
        }
        .komadai.active-sente { background: #bcaaa4; border-color: var(--sente-accent); box-shadow: 0 0 10px var(--sente-accent); }
        .komadai.active-gote { background: #bcaaa4; border-color: #eee; box-shadow: 0 0 10px #eee; }

        .board-wrapper { position: relative; background: #4e342e; padding: 10px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #board { display: grid; grid-template-columns: repeat(9, 60px); grid-template-rows: repeat(9, 66px); background: var(--board-bg); border: 1px solid var(--cell-border); }
        .cell { border: 0.5px solid var(--cell-border); display: flex; justify-content: center; align-items: center; position: relative; }
        .cell.selected { background: var(--highlight-bg); }
        .cell.can-move::after { content: ""; width: 14px; height: 14px; background-color: var(--move-dot); border-radius: 50%; position: absolute; }
        .piece { font-size: 44px; font-weight: bold; pointer-events: none; color: var(--sente-color); }
        .piece.gote { transform: rotate(180deg); }
        .piece.nari { color: var(--nari-color); }

        .side-panel { width: 380px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--ui-bg); padding: 15px; border-radius: 12px; border: 1px solid #a1887f; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card-title { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; border-left: 4px solid var(--btn-bg); padding-left: 8px; }

        .action-btn { 
            width: 100%; padding: 12px; font-weight: bold; border: none; border-radius: 6px; 
            color: #fff; background: var(--btn-bg); cursor: pointer; margin-top: 4px; 
            font-size: 1.1rem; /* スマホで押しやすく少し大きく */
            -webkit-appearance: none;
        }
        .action-btn:active { opacity: 0.7; transform: scale(0.95); }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; max-width: 540px; }

        input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 2px solid #a1887f; margin-bottom: 5px; font-size: 1rem; outline: none; touch-action: auto; }
        .kifu-select { width: 100%; padding: 8px; border-radius: 6px; height: 120px; font-size: 0.9rem; touch-action: auto; }
        .history-box { height: 200px; overflow-y: scroll; background: #efebe9; border: 1px solid #a1887f; border-radius: 6px; touch-action: auto; }
        .history-item { padding: 10px; border-bottom: 1px solid #d7ccc8; font-size: 0.9rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="board-area">
        <div class="komadai gote" id="goteKomadaiContainer"></div>
        <div class="board-wrapper">
            <div id="board"></div>
            <div id="promoteSelector" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; display: none; z-index: 100; gap: 40px; border: 3px solid var(--btn-bg);">
                <div onclick="processPromotion(true)" style="text-align:center; cursor:pointer;"><div class="piece sente nari" id="promoYesPiece"></div><div>成る</div></div>
                <div onclick="processPromotion(false)" style="text-align:center; cursor:pointer;"><div class="piece sente" id="promoNoPiece"></div><div>成らず</div></div>
            </div>
        </div>
        <div class="komadai sente" id="senteKomadaiContainer"></div>
        
        <div class="btn-grid">
            <button class="action-btn" onclick="jumpTo(0)">|&lt;</button>
            <button class="action-btn" onclick="prevMove()">&lt;</button>
            <button class="action-btn" onclick="nextMove()">&gt;</button>
            <button class="action-btn" onclick="jumpTo(history.length - 1)">&gt;|</button>
            <button class="action-btn" style="grid-column: span 2; background:#455a64;" onclick="undoLastMove()">1手消す</button>
            <button class="action-btn" style="grid-column: span 2; background:#8d6e63;" onclick="resetBoard()">盤面初期化</button>
        </div>
    </div>

    <div class="side-panel">
        <div class="card">
            <span class="card-title">保存・管理</span>
            <input type="text" id="kifuName" placeholder="棋譜名を入力...">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button class="action-btn" style="background:var(--sente-accent);" onclick="saveKifu(false)">上書き保存</button>
                <button class="action-btn" style="background:#e67e22;" onclick="saveKifu(true)">別名で保存</button>
            </div>
            <button class="action-btn" style="background:#34495e; margin-top:8px;" onclick="renameKifu()">リストの名称を変更</button>
        </div>
        <div class="card">
            <span class="card-title">棋譜リスト</span>
            <select id="kifuList" size="5" class="kifu-select"></select>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 5px;">
                <button class="action-btn" style="background:#2c3e50;" onclick="loadKifu()">読み込む</button>
                <button class="action-btn" style="background:#c0392b;" onclick="deleteKifu()">削除</button>
            </div>
        </div>
        <div class="card">
            <span class="card-title">全データ一括バックアップ</span>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button class="action-btn" style="background:#27ae60;" onclick="exportAllKifu()">全棋譜をDL</button>
                <button class="action-btn" style="background:#8e44ad;" onclick="document.getElementById('importFile').click()">全読込(復元)</button>
            </div>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="importAllKifu(event)">
        </div>
        <div class="card">
            <span class="card-title">履歴</span>
            <div id="history" class="history-box"></div>
        </div>
    </div>
</div>

<script>
    // 将棋ロジックは以前のまま、変更なし
    let history = []; let currentIndex = 0; let selected = null; let pendingMove = null;
    const kanjiMap = {'p':'歩','r':'飛','b':'角','g':'金','s':'銀','n':'桂','l':'香','k':'玉','+p':'と','+r':'竜','+b':'馬','+s':'全','+n':'圭','+l':'杏'};
    const komaOrder = ['r','b','g','s','n','l','p'];
    const STORAGE_KEY = 'SHOGI_LS_DATA_V2';

    const initBoard = [['L','N','S','G','K','G','S','N','L'],['','R','','','','','','B',''],['P','P','P','P','P','P','P','P','P'],['','','','','','','','',''],['','','','','','','','',''],['','','','','','','','',''],['p','p','p','p','p','p','p','p','p'],['','b','','','','','','r',''],['l','n','s','g','k','g','s','n','l']];
    history.push({ board: JSON.parse(JSON.stringify(initBoard)), senteMoti: [], goteMoti: [], moveText: "開始局面", turn: 0 });

    document.getElementById('kifuList').addEventListener('change', function() {
        if (this.value) document.getElementById('kifuName').value = this.value;
    });

    function render() {
        const data = history[currentIndex]; if (!data) return;
        const boardEl = document.getElementById('board'); boardEl.innerHTML = '';
        document.getElementById('senteKomadaiContainer').className = "komadai sente" + (data.turn===0 ? " active-sente":"");
        document.getElementById('goteKomadaiContainer').className = "komadai gote" + (data.turn===1 ? " active-gote":"");

        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                const cell = document.createElement('div'); cell.className = 'cell';
                const p = data.board[r][c];
                if (selected?.type === 'board' && selected.fr === r && selected.fc === c) cell.classList.add('selected');
                if (selected?.type === 'board' && isValidMove(selected.fr, selected.fc, r, c, data.board[selected.fr][selected.fc], data.board)) cell.classList.add('can-move');
                if (selected?.type === 'moti' && p === '' && canExistAt(selected.piece, r, data.turn===0) && !(selected.piece==='p' && isNifu(data.board, c, data.turn===0))) cell.classList.add('can-move');
                if (p) {
                    const span = document.createElement('span');
                    span.className = 'piece ' + (p===p.toUpperCase()?'gote ':'sente ') + (p.includes('+')?'nari':'');
                    span.innerText = kanjiMap[p.toLowerCase()]; cell.appendChild(span);
                }
                cell.onclick = (e) => { e.preventDefault(); handleCellClick(r, c); }; 
                boardEl.appendChild(cell);
            }
        }
        renderMoti('senteKomadaiContainer', data.senteMoti || [], 0);
        renderMoti('goteKomadaiContainer', data.goteMoti || [], 1);
        updateHistoryUI();
    }

    function renderMoti(id, pieces, owner) {
        const el = document.getElementById(id); el.innerHTML = '';
        const counts = {}; pieces.forEach(p => counts[p] = (counts[p] || 0) + 1);
        komaOrder.forEach(type => {
            if (counts[type]) {
                const group = document.createElement('div');
                group.className = 'moti-group';
                const span = document.createElement('span'); span.className = 'moti-piece' + (owner === 1 ? ' gote' : '');
                span.innerText = kanjiMap[type]; group.appendChild(span);
                if (counts[type] > 1) {
                    const badge = document.createElement('span'); badge.className = 'moti-count';
                    badge.innerText = counts[type]; group.appendChild(badge);
                }
                group.onclick = (e) => { e.preventDefault(); e.stopPropagation(); if (history[currentIndex].turn === owner) { selected = {type: 'moti', piece: type, owner: owner}; render(); } };
                el.appendChild(group);
            }
        });
    }

    function jumpTo(index) { currentIndex = Math.max(0, Math.min(index, history.length - 1)); selected = null; render(); }
    function prevMove() { jumpTo(currentIndex - 1); }
    function nextMove() { jumpTo(currentIndex + 1); }
    
    function handleCellClick(r, c) {
        const data = history[currentIndex];
        if (currentIndex < history.length - 1 && !selected) { history = history.slice(0, currentIndex + 1); }
        if (selected) {
            if (selected.type === 'board') { 
                if (isValidMove(selected.fr, selected.fc, r, c, data.board[selected.fr][selected.fc], data.board)) checkPromotion(selected.fr, selected.fc, r, c, data.board[selected.fr][selected.fc]);
            } else if (selected.type === 'moti') { 
                if (data.board[r][c] === '' && canExistAt(selected.piece, r, data.turn===0) && !(selected.piece==='p' && isNifu(data.board, c, data.turn===0))) executeDrop(selected.piece, r, c);
            }
            selected = null;
        } else { 
            const p = data.board[r][c]; 
            if (p && ((data.turn===0 && p===p.toLowerCase()) || (data.turn===1 && p===p.toUpperCase()))) selected = {type:'board', fr:r, fc:c}; 
        }
        render();
    }

    function canExistAt(t, row, isS) { if (isS) { if (t==='p'||t==='l') return row>0; if (t==='n') return row>1; } else { if (t==='p'||t==='l') return row<8; if (t==='n') return row<7; } return true; }
    function isNifu(b, col, isS) { const target = isS ? 'p' : 'P'; for (let r = 0; r < 9; r++) if (b[r][col] === target) return true; return false; }
    function isValidMove(fr, fc, tr, tc, p, b) {
        const isS = p === p.toLowerCase(); const dr = tr-fr, dc = tc-fc, adr = Math.abs(dr), adc = Math.abs(dc);
        if (b[tr][tc] !== '' && (b[tr][tc] === b[tr][tc].toLowerCase()) === isS) return false;
        const t = p.toLowerCase();
        const checkPath = () => { const sr=dr===0?0:dr/adr, sc=dc===0?0:dc/adc; let cr=fr+sr, cc=fc+sc; while(cr!==tr||cc!==tc){if(b[cr][cc]!=='')return false; cr+=sr; cc+=sc;} return true; };
        switch (t) {
            case 'p': return dc===0 && (isS ? dr===-1 : dr===1);
            case 'l': return dc===0 && (isS ? dr<0 : dr>0) && checkPath();
            case 'n': return adc===1 && (isS ? dr===-2 : dr===2);
            case 's': return (adr===1 && adc===1) || (adc===0 && (isS ? dr===-1 : dr===1));
            case 'g': case '+p': case '+l': case '+n': case '+s': return (adr<=1 && adc<=1) && !(isS ? (dr===1 && adc===1) : (dr===-1 && adc===1));
            case 'k': return adr<=1 && adc<=1;
            case 'r': return (dr===0 || dc===0) && checkPath();
            case '+r': return (dr===0 || dc===0 && checkPath()) || (adr===1 && adc===1);
            case 'b': return adr===adc && checkPath();
            case '+b': return (adr===adc && checkPath()) || (adr<=1 && adc<=1);
        } return false;
    }

    function checkPromotion(fr,fc,tr,tc,p) {
        const isS = p===p.toLowerCase(); const t = p.toLowerCase();
        const must = !canExistAt(t, tr, isS);
        const can = ['p','l','n','s','b','r'].includes(t) && !p.includes('+') && (isS ? tr<=2||fr<=2 : tr>=6||fr>=6);
        if (must) executeMove(fr,fc,tr,tc,p,true);
        else if (can) { pendingMove = {fr,fc,tr,tc,p}; document.getElementById('promoYesPiece').innerText = kanjiMap['+'+t]; document.getElementById('promoNoPiece').innerText = kanjiMap[t]; document.getElementById('promoteSelector').style.display='flex'; }
        else executeMove(fr,fc,tr,tc,p,false);
    }
    function processPromotion(n) { document.getElementById('promoteSelector').style.display='none'; executeMove(pendingMove.fr, pendingMove.fc, pendingMove.tr, pendingMove.tc, pendingMove.p, n); }
    function executeMove(fr,fc,tr,tc,p,n) {
        const d = history[currentIndex]; const nb = JSON.parse(JSON.stringify(d.board)); const sm = [...d.senteMoti], gm = [...d.goteMoti];
        if (nb[tr][tc]) { const c = nb[tr][tc].replace('+','').toLowerCase(); if(d.turn===0) sm.push(c); else gm.push(c); }
        let f = n ? "+"+p : p; nb[tr][tc]=f; nb[fr][fc]='';
        history.push({ board:nb, senteMoti:sm, goteMoti:gm, moveText:(d.turn==0?"▲":"△")+kanjiMap[f.toLowerCase()]+(n?"成":"")+`(${9-fc}${fr+1}→${9-tc}${tr+1})`, turn:1-d.turn });
        currentIndex++; render();
    }
    function executeDrop(p, r, c) {
        const d = history[currentIndex]; const nb = JSON.parse(JSON.stringify(d.board)); const sm = [...d.senteMoti], gm = [...d.goteMoti];
        nb[r][c] = (d.turn===0) ? p.toLowerCase() : p.toUpperCase();
        const target = d.turn===0 ? sm : gm; target.splice(target.indexOf(p), 1);
        history.push({ board:nb, senteMoti:sm, goteMoti:gm, moveText:(d.turn==0?"▲":"△")+kanjiMap[p.toLowerCase()]+`打(${9-c}${r+1})`, turn:1-d.turn });
        currentIndex++; render();
    }
    function updateHistoryUI() { const h = document.getElementById('history'); h.innerHTML = history.map((x,i) => `<div class="history-item ${i==currentIndex?'current-move':''}" onclick="jumpTo(${i})">${i}. ${x.moveText}</div>`).join(''); h.scrollTop = h.scrollHeight; }
    function undoLastMove() { if(history.length>1){ history.pop(); currentIndex = history.length - 1; render(); } }
    function resetBoard() { if(confirm("初期化しますか？")){ history=[history[0]]; currentIndex=0; render(); } }

    function getS() { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
    function setS(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    function saveKifu(isAsNew) {
        const name = document.getElementById('kifuName').value;
        if (!name) return alert("名前を入れてください");
        const data = getS();
        if (!isAsNew && data[name] && !confirm("上書きしますか？")) return;
        if (isAsNew && data[name]) return alert("その名前は既に存在します。");
        data[name] = history; setS(data); updateList(); alert("保存しました");
    }

    function renameKifu() {
        const oldName = document.getElementById('kifuList').value;
        const newName = document.getElementById('kifuName').value;
        if (!oldName) return alert("リストから選択してください");
        if (!newName || oldName === newName) return alert("新しい名前を入力してください");
        const data = getS();
        if (data[newName]) return alert("既に存在します");
        data[newName] = data[oldName]; delete data[oldName]; setS(data); updateList();
        document.getElementById('kifuList').value = newName; alert("変更しました");
    }

    function loadKifu() {
        const n = document.getElementById('kifuList').value;
        if (!n) return alert("選んでください");
        const data = getS();
        if (data[n]) { history = data[n]; currentIndex = 0; selected = null; render(); }
    }

    function deleteKifu() {
        const n = document.getElementById('kifuList').value;
        if (n && confirm(`「${n}」を削除しますか？`)) { const d = getS(); delete d[n]; setS(d); updateList(); }
    }

    function updateList() {
        const d = getS(); const l = document.getElementById('kifuList');
        l.innerHTML = Object.keys(d).sort().map(k => `<option value="${k}">${k}</option>`).join('');
    }

    function exportAllKifu() {
        const data = getS();
        if (Object.keys(data).length === 0) return alert("データがありません。");
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        const now = new Date();
        const dateStr = now.getFullYear() + (now.getMonth()+1).toString().padStart(2,'0') + now.getDate().toString().padStart(2,'0');
        a.href = URL.createObjectURL(blob);
        a.download = `shogi_backup_${dateStr}.json`;
        a.click();
    }

    function importAllKifu(e) {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            try {
                const importedData = JSON.parse(ev.target.result);
                if (confirm("現在の全ての棋譜に統合・上書きしますか？")) {
                    const currentData = getS();
                    const newData = { ...currentData, ...importedData };
                    setS(newData); updateList(); alert("データを復元・統合しました。");
                }
            } catch { alert("無効なファイルです。"); }
        };
        r.readAsText(f); e.target.value = "";
    }

    window.onload = () => { render(); updateList(); };
</script>
</body>
</html>